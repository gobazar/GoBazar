<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GoBazar - আপনার এলাকার বিশ্বস্ত বাজার</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: 'Hind Siliguri', sans-serif; background:#f9fafb; scroll-behavior:smooth; }
    .card-hover { transition: transform .25s, box-shadow .25s; }
    .card-hover:hover { transform: translateY(-6px); box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
    .hero { background: linear-gradient(90deg,#00BFA6,#00cfa1); color:#fff; }
    .shop-cover { border-radius:.75rem; overflow:hidden; height:260px; background:#e6ffe9; position:relative; }
    .shop-cover img { width:100%; height:100%; object-fit:cover; display:block; }
    .shop-info { position: relative; z-index: 10; }
    .shop-profile { width:100px; height:100px; border-radius:9999px; border:4px solid #fff; object-fit:cover; box-shadow:0 6px 18px rgba(0,0,0,0.12); }
    .stats-bar { display:inline-flex; gap:14px; background:#fff; padding:8px 14px; border-radius:9999px; box-shadow:0 6px 18px rgba(2,6,23,0.06); font-size:15px; color:#111; align-items:center; }
    .stats-bar i { color:#00BFA6; margin-right:6px; }
    .follow-btn { background:#00BFA6; color:#fff; padding:8px 18px; border-radius:9999px; font-weight:600; }
    .follow-btn.following { background:#e6eef0; color:#1f2937; }
    .back-btn-static { display:inline-flex; align-items:center; gap:8px; background:#fff; color:#0f766e; padding:8px 12px; border-radius:9999px; box-shadow:0 6px 18px rgba(2,6,23,0.06); border: none; cursor:pointer; font-weight:600; }
    .back-btn-static:hover { transform:translateY(-2px); }
    #toast { position:fixed; right:20px; bottom:20px; background:#00BFA6; color:#fff; padding:10px 14px; border-radius:8px; box-shadow:0 8px 30px rgba(2,6,23,0.12); opacity:0; transform:translateY(12px); transition:all .25s; z-index:60; }
    #toast.show { opacity:1; transform:translateY(0); }
    /* Category button styling for cleaner tabs */
    .category-btn { background-color: transparent; color: #4b5563; padding: 8px 16px; border-radius: 9999px; font-weight: 500; border: 2px solid transparent; transition: all 0.2s; }
    .category-btn:hover { background-color: #e6f7f5; color: #0f766e; }
    .category-btn.active { background-color: #00BFA6; color: white; border-color: #00BFA6; font-weight: 600; }
    .profile-tab-btn { flex: 1; padding: 12px; font-weight: 600; color: #4b5563; border-bottom: 2px solid transparent; }
    .profile-tab-btn.active { color: #00BFA6; border-bottom-color: #00BFA6; }
    
    /* Styles for Glassmorphism Modal */
    .modal-backdrop {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.4); 
      backdrop-filter: blur(8px); 
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .glass-modal {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      max-width: 400px;
      width: 90%;
      padding: 30px;
      text-align: center;
      transform: scale(0.9);
      opacity: 0;
      transition: all 0.3s ease;
    }
    .modal-backdrop.active .glass-modal {
      transform: scale(1);
      opacity: 1;
    }
    /* Style for Detailed Order Modal */
    #order-detail-modal .glass-modal { max-width: 500px; padding: 20px; text-align: left; }
    .modal-close-btn-x { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; color: #fff; cursor: pointer; }
    
  </style>
</head>
<body>
  <header class="bg-white shadow-md sticky top-0 z-40 p-3">
    <div class="max-w-7xl mx-auto flex justify-between items-center gap-4 px-4">
      <img id="customer-logo" src="GoBazar_logo.png" alt="GoBazar Logo" class="h-10 cursor-pointer hidden sm:block" />
       <div class="relative flex-grow max-w-xl mx-auto">
        <input id="search-bar" type="text" placeholder="দোকান বা পণ্যের নাম দিয়ে খুঁজুন..." class="w-full py-2 px-4 pr-10 rounded-full text-gray-700 bg-gray-100 focus:outline-none focus:ring-2 focus:ring-[#00BFA6]">
        <div class="absolute top-1/2 right-3 -translate-y-1/2 text-gray-400"><i class="fas fa-search"></i></div>
      </div>
      <div class="flex items-center gap-4">
        <button id="cart-btn" aria-label="Open cart" class="relative text-gray-600 hover:text-teal-600">
          <i class="fas fa-shopping-cart text-xl"></i>
          <span id="cart-count" class="absolute -top-2 -right-2 bg-teal-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
        </button>
        <button id="profile-btn" aria-label="Profile" class="text-gray-600 hover:text-teal-600">
          <i class="fas fa-user-circle text-2xl"></i>
        </button>
      </div>
    </div>
  </header>

  <section id="hero" class="hero text-center py-16 px-4">
    <h1 class="text-4xl md:text-5xl font-bold">আপনার এলাকার বিশ্বস্ত বাজার</h1>
    <p class="mt-3 text-lg text-white/90">আপনার প্রয়োজনীয় সবকিছু অর্ডার করুন এক নিমিষেই।</p>
  </section>

  <div class="max-w-7xl mx-auto p-6">
    <main id="main-page"></main>

    <section id="all-products-page" class="hidden"></section>
    <section id="all-shops-page" class="hidden"></section> 

    <section id="product-details-page" class="hidden"></section>
    <section id="shop-products-page" class="hidden"></section>
    <section id="cart-page" class="hidden"></section>
    <section id="profile-page" class="hidden"></section>
  </div>

  <footer class="bg-white py-8 mt-12 border-t">
    <div class="max-w-7xl mx-auto text-center text-gray-600">© ২০২৫ GoBazar. সর্বস্বত্ব সংরক্ষিত।</div>
  </footer>
  
  <div id="checkout-modal" class="modal-backdrop hidden">
    <div class="glass-modal">
      <i class="fas fa-check-circle text-6xl text-[#00BFA6] mb-4"></i>
      <h3 class="text-2xl font-bold text-white mb-2" id="modal-title">অর্ডার সফল</h3>
      <p class="text-white/80 mb-4" id="modal-message">আপনার অর্ডারটি সফলভাবে প্রক্রিয়াকরণ করা হয়েছে।</p>
      
      <div class="bg-white/30 p-4 rounded-lg text-left mb-4">
        <p class="font-semibold text-white/90" id="modal-order-id-container">অর্ডার আইডি: <span id="modal-order-id" class="font-normal"></span></p>
        <p class="font-semibold text-white/90">মোট মূল্য: <span id="modal-total" class="font-normal text-[#00BFA6]"></span></p>
      </div>
      
      <button id="modal-close-btn" class="w-full bg-[#00BFA6] hover:bg-[#00a892] text-white py-2 rounded-lg font-semibold transition">হোমপেজে ফিরুন</button>
    </div>
  </div>

  <div id="order-detail-modal" class="modal-backdrop hidden">
        <div class="glass-modal relative">
            <button class="modal-close-btn-x" id="order-detail-close-btn-x">&times;</button>
            <h3 class="text-xl font-bold text-white mb-4 border-b border-white/30 pb-2">অর্ডারের বিস্তারিত</h3>
            <div id="order-detail-content">
                </div>
             <button id="order-detail-close-btn" class="w-full bg-[#00BFA6] hover:bg-[#00a892] text-white py-2 rounded-lg font-semibold transition mt-4">বন্ধ করুন</button>
        </div>
    </div>


  <div id="toast"><i class="fas fa-check-circle mr-2"></i> <span id="toast-msg"></span></div>

  <script>
    // --- Constants ---
    const SHIPPING_COST = 40; 
    const MAX_HOME_PRODUCTS = 10;
    const MAX_HOME_SHOPS = 6;
    const SIMULATED_USER_LOCATION = 'AreaA'; 

    // --- Data ---
    const MOCK_DATA = {
      shops: [
        { id:'shop1', name:'ময়মনসিংহ সবজি ভান্ডার', address:'নতুন বাজার, ময়মনসিংহ', rating:4.8, imageUrl:'https://placehold.co/800x400/00BFA6/FFFFFF?text=সবজি+ভান্ডার', cover:'https://placehold.co/1200x400/008b73/FFFFFF?text=সবজি+বাজার+Cover', area: 'AreaA' },
        { id:'shop2', name:'ফ্রেশ ফিশ ডেলিভারি', address:'চরপাড়া, ময়মনসিংহ', rating:4.6, imageUrl:'https://placehold.co/800x400/009688/FFFFFF?text=ফ্রেশ+ফিশ', cover:'https://placehold.co/1200x400/004d40/FFFFFF?text=Fish+Delivery+Cover', area: 'AreaA' },
        { id:'shop3', name:'ভাই ভাই স্টোর (মুদি)', address:'গাঙ্গিনারপাড়, ময়মনসিংহ', rating:4.9, imageUrl:'https://placehold.co/800x400/005f50/FFFFFF?text=ভাই+ভাই+স্টোর', cover:'https://placehold.co/1200x400/005f50/FFFFFF?text=ভাই+ভাই+Cover', area: 'AreaA' },
        { id:'shop4', name:'ফার্মেসি ও কসমেটিকস', address:'মাসকান্দা, ময়মনসিংহ', rating:4.5, imageUrl:'https://placehold.co/800x400/D4AF37/FFFFFF?text=Pharmacy', cover:'https://placehold.co/1200x400/B8860B/FFFFFF?text=Health+Cover', area: 'AreaB' }, 
        { id:'shop5', name:'তাজা মাংস ঘর', address:'নতুন বাজার, ময়মনসিংহ', rating:4.7, imageUrl:'https://placehold.co/800x400/A30000/FFFFFF?text=Meat+Shop', cover:'https://placehold.co/1200x400/660000/FFFFFF?text=Meat+Cover', area: 'AreaA' },
        { id:'shop6', name:'মায়ের দোয়া বেকারি', address:'সি.কে. ঘোষ রোড, ময়মনসিংহ', rating:4.8, imageUrl:'https://placehold.co/800x400/FFC107/333333?text=Bakery', cover:'https://placehold.co/1200x400/FF8F00/FFFFFF?text=Bakery+Cover', area: 'AreaA' },
        { id:'shop7', name:'স্টুডেন্ট লাইব্রেরি ও স্টেশনারি', address:'কলেজ রোড, ময়মনসিংহ', rating:4.9, imageUrl:'https://placehold.co/800x400/2196F3/FFFFFF?text=Stationery', cover:'https://placehold.co/1200x400/0D47A1/FFFFFF?text=Library+Cover', area: 'AreaA' },
        { id:'shop8', name:'কিডস অ্যান্ড মমস্ কেয়ার', address:'শেওড়া, ময়মনসিংহ', rating:4.7, imageUrl:'https://placehold.co/800x400/E91E63/FFFFFF?text=Baby+Care', cover:'https://placehold.co/1200x400/880E4F/FFFFFF?text=Kids+Care+Cover', area: 'AreaB' }
      ],
      products: [
        { id:'p1', shopId:'shop1', name:'তাজা টমেটো', price:60, unit:'কেজি', category:'শাকসবজি', imageUrl:'https://placehold.co/400x300/00BFA6/FFFFFF?text=Tomato' },
        { id:'p2', shopId:'shop1', name:'দেশি আলু', price:40, unit:'কেজি', category:'শাকসবজি', imageUrl:'https://placehold.co/400x300/00BFA6/FFFFFF?text=Potato' },
        { id:'p3', shopId:'shop2', name:'নদীর রুই মাছ', price:350, unit:'কেজি', category:'মাছ', imageUrl:'https://placehold.co/400x300/009688/FFFFFF?text=Rohi+Fish' },
        { id:'p4', shopId:'shop2', name:'ইলিশ মাছ (মাঝারি)', price:800, unit:'পিস', category:'মাছ', imageUrl:'https://placehold.co/400x300/009688/FFFFFF?text=Hilsa+Fish' },
        { id:'p5', shopId:'shop3', name:'আড়ং দুধ (১ লিটার)', price:90, unit:'প্যাকেট', category:'দুধ ও পানীয়', imageUrl:'https://placehold.co/400x300/005f50/FFFFFF?text=Milk' },
        { id:'p6', shopId:'shop3', name:'ফ্রেশ চিনি (১ কেজি)', price:130, unit:'কেজি', category:'মুদি', imageUrl:'https://placehold.co/400x300/005f50/FFFFFF?text=Sugar' },
        { id:'p7', shopId:'shop3', name:'রূপচাঁদা সয়াবিন তেল', price:180, unit:'১ লিটার', category:'মুদি', imageUrl:'https://placehold.co/400x300/005f50/FFFFFF?text=Oil' },
        { id:'p11', shopId:'shop3', name:'লবণ (প্যাকেট)', price:35, unit:'১ কেজি', category:'মুদি', imageUrl:'https://placehold.co/400x300/005f50/FFFFFF?text=Salt' },
        { id:'p12', shopId:'shop3', name:'বাসমতী চাল (৫ কেজি)', price:450, unit:'প্যাকেট', category:'মুদি', imageUrl:'https://placehold.co/400x300/005f50/FFFFFF?text=Rice' },
        { id:'p8', shopId:'shop5', name:'ফার্মের মুরগি (ব্রয়লার)', price:210, unit:'কেজি', category:'মাংস', imageUrl:'https://placehold.co/400x300/A30000/FFFFFF?text=Chicken' },
        { id:'p9', shopId:'shop5', name:'খাসির মাংস', price:1000, unit:'কেজি', category:'মাংস', imageUrl:'https://placehold.co/400x300/A30000/FFFFFF?text=Mutton' },
        { id:'p10', shopId:'shop4', name:'প্যারাসিটামল ট্যাবলেট', price:1, unit:'পিস', category:'স্বাস্থ্য ও পরিচর্যা', imageUrl:'https://placehold.co/400x300/D4AF37/FFFFFF?text=Paracetamol' },
        { id:'p13', shopId:'shop6', name:'পাউরুটি (স্লাইস)', price:50, unit:'প্যাকেট', category:'বেকারি', imageUrl:'https://placehold.co/400x300/FFC107/333333?text=Bread' },
        { id:'p14', shopId:'shop6', name:'বাটার বিস্কুট', price:80, unit:'প্যাকেট', category:'বেকারি', imageUrl:'https://placehold.co/400x300/FFC107/333333?text=Biscuit' },
        { id:'p15', shopId:'shop6', name:'প্লেইন কেক', price:250, unit:'পাউন্ড', category:'বেকারি', imageUrl:'https://placehold.co/400x300/FFC107/333333?text=Cake' },
        { id:'p16', shopId:'shop7', name:'ম্যাটাদোর বলপেন', price:5, unit:'পিস', category:'স্টেশনারি', imageUrl:'https://placehold.co/400x300/2196F3/FFFFFF?text=Pen' },
        { id:'p17', shopId:'shop7', name:'খাতা (১২০ পৃষ্ঠা)', price:40, unit:'পিস', category:'স্টেশনারি', imageUrl:'https://placehold.co/400x300/2196F3/FFFFFF?text=Notebook' },
        { id:'p18', shopId:'shop7', name:'জ্যামিতি বক্স', price:120, unit:'সেট', category:'স্টেশনারি', imageUrl:'https://placehold.co/400x300/2196F3/FFFFFF?text=Geomentry+Box' },
        { id:'p19', shopId:'shop8', name:'হাগিস ডায়াপার (মিডিয়াম)', price:600, unit:'প্যাকেট', category:'বেবি কেয়ার', imageUrl:'https://placehold.co/400x300/E91E63/FFFFFF?text=Diaper' },
        { id:'p20', shopId:'shop8', name:'জনসন বেবি লোশন', price:250, unit:'বোতল', category:'বেবি কেয়ার', imageUrl:'https://placehold.co/400x300/E91E63/FFFFFF?text=Baby+Lotion' },
        { id:'p21', shopId:'shop8', name:'জারবার বেবি ফুড', price:180, unit:'বয়ম', category:'বেবি কেয়ার', imageUrl:'https://placehold.co/400x300/E91E63/FFFFFF?text=Baby+Food' }
      ]
    };

    // --- User Location Logic ---
    function getShopsByProximity(userArea) {
        return MOCK_DATA.shops.filter(shop => shop.area === userArea);
    }
    
    // --- State ---
    let cart = [];
    let followedShops = [];
    let favoriteProducts = JSON.parse(localStorage.getItem('goBazarFavorites')) || []; 
    let orderHistory = [
      { id: 'ord_12345_0', date: 'অক্টোবর ১২, ২০২৫', productTotal: 430, shipping: 40, total: 470, status: 'ডেলিভারি হয়েছে', shopId: 'shop2', items: [{ name: 'নদীর রুই মাছ', quantity: 1, price: 350 }, { name: 'দেশি আলু', quantity: 2, price: 40 }] }
    ];

    // --- Helpers ---
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const findProduct = (id) => MOCK_DATA.products.find(p => p.id === id); 
    const findShop = (id) => MOCK_DATA.shops.find(s => s.id === id);

    function saveFavorites() {
        localStorage.setItem('goBazarFavorites', JSON.stringify(favoriteProducts));
    }

    function showToast(text) {
      const t = $('#toast');
      $('#toast-msg').textContent = text;
      t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 2500);
    }

    function updateCartCount() {
      const count = cart.reduce((s,i)=> s + i.quantity, 0);
      $('#cart-count').textContent = count;
    }

    function showPage(id, shouldScroll = true) { 
      ['main-page','shop-products-page','cart-page','profile-page', 'product-details-page', 'all-shops-page', 'all-products-page'].forEach(p => {
        const el = document.getElementById(p);
        if(!el) return;
        el.classList.toggle('hidden', p !== id);
      });
      $('#hero').classList.toggle('hidden', id !== 'main-page');
      if (shouldScroll) {
          window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    function productCardHTML(p, shop) {
        const isFavorite = favoriteProducts.includes(p.id);
        return `
            <div class="bg-white rounded-xl shadow flex flex-col justify-between relative border card-hover">
                <button class="favorite-btn absolute top-3 right-3 text-xl z-20 p-2" data-id="${p.id}" title="পছন্দের তালিকা">
                    <i class="fas fa-heart ${isFavorite ? 'text-red-500' : 'text-gray-300 hover:text-red-500'}"></i>
                </button>
                <div class="product-card-clickable cursor-pointer p-3" data-id="${p.id}">
                    <img src="${p.imageUrl}" alt="${p.name}" class="w-full h-32 object-cover rounded-lg mb-2" loading="lazy">
                    
                    <h4 class="font-semibold text-gray-800">${p.name}</h4>
                    <p class="text-xs text-[#00BFA6] font-medium mt-1 mb-2">${shop.name}</p> 
                    <div class="flex items-end">
                       <p class="text-lg font-bold text-gray-700">৳${p.price}</p>
                       <p class="text-sm text-gray-500 ml-1">/${p.unit}</p>
                    </div>
                </div>
                <button class="add-to-cart mx-3 mb-3 bg-[#00BFA6] hover:bg-[#00a892] text-white py-2 rounded-lg text-sm transition" data-id="${p.id}">
                    <i class="fas fa-plus mr-1"></i> কার্টে নিন
                </button>
            </div>
        `;
    }

    function renderShopCardsHTML(shops) {
        return shops.map(s => `
            <div class="bg-white rounded-xl shadow card-hover overflow-hidden cursor-pointer" data-shop-id="${s.id}">
                <img src="${s.imageUrl}" alt="${s.name}" class="w-full h-48 object-cover" loading="lazy">
                <div class="p-4">
                    <h3 class="text-lg font-semibold text-gray-800">${s.name}</h3>
                    <p class="text-sm text-gray-600"><i class="fas fa-map-marker-alt text-[#00BFA6] mr-1"></i>${s.address}</p>
                    <div class="text-yellow-400 mt-2"><i class="fas fa-star"></i> ${s.rating}</div>
                </div>
            </div>
        `).join('');
    }
    
    // --- Toggle Favorite (Wishlist) ---
    function toggleFavorite(productId, btnEl) {
        const product = findProduct(productId);
        if (!product) return;

        if (favoriteProducts.includes(productId)) {
            favoriteProducts = favoriteProducts.filter(id => id !== productId);
            if (btnEl) btnEl.classList.remove('text-red-500'); 
            showToast(`${product.name} পছন্দ তালিকা থেকে সরানো হয়েছে।`);
        } else {
            favoriteProducts.push(productId);
            if (btnEl) btnEl.classList.add('text-red-500'); 
            showToast(`${product.name} পছন্দের তালিকায় যোগ করা হয়েছে।`);
        }
        
        saveFavorites();
        
        const filter = $('#search-bar').value;
        if (!document.getElementById('main-page').classList.contains('hidden')) {
             const activeCategory = document.querySelector('#product-category-filters .active')?.dataset.cat || 'all';
             renderProductGrid(filter, activeCategory, '#products-container', MAX_HOME_PRODUCTS);
        }
        if (!document.getElementById('all-products-page').classList.contains('hidden')) {
             const activeCategory = document.querySelector('#all-product-category-filters .active')?.dataset.cat || 'all';
             renderProductGrid(filter, activeCategory, '#all-products-container', Infinity);
        }
        if (!document.getElementById('product-details-page').classList.contains('hidden')) {
             renderProductDetails(productId, false); 
        }
        const currentActiveTab = document.querySelector('.profile-tab-btn.active')?.dataset.tab;
        if (!document.getElementById('profile-page').classList.contains('hidden') && currentActiveTab === 'favorites') {
            renderFavoriteProducts();
        }
    }

    // --- Renders the product grid with filtering and LIMIT ---
    function renderProductGrid(filter = '', activeCategory = 'all', containerId = '#products-container', limit = Infinity) {
        const localShopIds = getShopsByProximity(SIMULATED_USER_LOCATION).map(s => s.id);
        let filteredProducts = MOCK_DATA.products.filter(p => localShopIds.includes(p.shopId)); 
        
        if (activeCategory !== 'all') {
            filteredProducts = filteredProducts.filter(p => p.category === activeCategory);
        }

        if (filter) {
            filteredProducts = filteredProducts.filter(p => 
                p.name.toLowerCase().includes(filter.toLowerCase())
            );
        }
        
        const productsToDisplay = filteredProducts.slice(0, limit);
        const container = $(containerId);
        
        if (productsToDisplay.length === 0) {
            container.innerHTML = `<p class="text-center col-span-full text-gray-500 py-8">এই ক্যাটাগরিতে কোনো পণ্য খুঁজে পাওয়া যায়নি।</p>`;
            return;
        }

        container.innerHTML = productsToDisplay.map(p => {
            const shop = findShop(p.shopId);
            return productCardHTML(p, shop);
        }).join('');
        
        $$(containerId + ' .add-to-cart').forEach(b => b.addEventListener('click', (e) => {
             e.stopPropagation(); 
             addToCart(b.dataset.id);
        }));
        $$(containerId + ' .favorite-btn').forEach(b => b.addEventListener('click', (e) => {
             e.stopPropagation(); 
             toggleFavorite(b.dataset.id, e.currentTarget.querySelector('i'));
        }));
        $$(containerId + ' .product-card-clickable').forEach(el => {
            el.addEventListener('click', () => renderProductDetails(el.dataset.id));
        });
    }

    // --- Product Details Page (Feature 1: Clickable Shop Name) ---
    function renderProductDetails(productId, shouldScroll = true) {
        const product = findProduct(productId);
        if (!product) { renderShops(); return; }
        const shop = findShop(product.shopId);
        const isFavorite = favoriteProducts.includes(productId);

        const page = $('#product-details-page');
        page.innerHTML = `
            <div class="max-w-4xl mx-auto px-4">
                <div class="mb-4">
                    <button class="back-btn-static" onclick="renderShops()"><i class="fas fa-arrow-left"></i> হোমপেজে ফিরুন</button>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 md:p-10 grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-auto object-cover rounded-xl shadow-md">
                    </div>
                    
                    <div>
                        <div class="flex justify-between items-start">
                            <h1 class="text-3xl font-bold text-gray-800">${product.name}</h1>
                            <button id="detail-favorite-btn" class="text-3xl p-1" data-id="${product.id}" title="পছন্দের তালিকা">
                                <i class="fas fa-heart ${isFavorite ? 'text-red-500' : 'text-gray-300 hover:text-red-500'}"></i>
                            </button>
                        </div>
                        
                        <p class="text-xl font-bold text-[#00BFA6] my-4">৳${product.price} / ${product.unit}</p>

                        <div class="mb-6 pb-4 border-b">
                            <h3 class="text-lg font-semibold mb-2">দোকানের তথ্য</h3>
                            <p class="text-gray-600">
                                <i class="fas fa-store text-sm mr-2"></i> 
                                <span id="shop-name-link" class="text-[#00BFA6] font-medium cursor-pointer hover:underline" data-shop-id="${shop.id}">${shop.name}</span>
                            </p>
                            <p class="text-sm text-gray-500 mt-1"><i class="fas fa-map-marker-alt text-sm mr-2"></i> ${shop.address}</p>
                        </div>
                        
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-2">পণ্যের বিবরণ</h3>
                            <p class="text-gray-700">এটি ময়মনসিংহ এলাকার একটি জনপ্রিয় দোকান থেকে পাওয়া সেরা মানের ${product.category} পণ্য। স্বাস্থ্যকর ও তাজা পণ্যের জন্য আস্থা রাখুন GoBazar-এ।</p>
                        </div>

                        <button id="detail-add-to-cart-btn" class="w-full bg-[#00BFA6] hover:bg-[#00a892] text-white py-3 rounded-lg font-semibold text-lg transition" data-id="${product.id}">
                            <i class="fas fa-cart-plus mr-2"></i> কার্টে যোগ করুন
                        </button>
                    </div>
                </div>
            </div>
        `;
        showPage('product-details-page', shouldScroll);
        
        $('#detail-add-to-cart-btn').addEventListener('click', () => addToCart(productId));
        $('#detail-favorite-btn').addEventListener('click', (e) => toggleFavorite(productId, e.currentTarget.querySelector('i')));
        
        $('#shop-name-link').addEventListener('click', (e) => {
            renderShopProducts(e.currentTarget.dataset.shopId);
        });
    }

    // --- All Shops Page ---
    function renderAllShopsPage() {
        showPage('all-shops-page');
        const page = $('#all-shops-page');
        const localShops = getShopsByProximity(SIMULATED_USER_LOCATION);

        page.innerHTML = `
            <div class="max-w-7xl mx-auto px-4">
                <div class="mb-6">
                    <button class="back-btn-static" onclick="renderShops()"><i class="fas fa-arrow-left"></i> হোমপেজে ফিরুন</button>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-3">আপনার এলাকার সকল দোকান</h2>
                <div id="all-shops-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${renderShopCardsHTML(localShops)}
                </div>
            </div>
        `;
        
        $$('#all-shops-container [data-shop-id]').forEach(card => {
            card.addEventListener('click', () => renderShopProducts(card.dataset.shopId));
        });
    }

    // --- All Products Page ---
    function renderAllProductsPage(filter = '', activeCategory = 'all') {
        showPage('all-products-page');
        const page = $('#all-products-page');
        
        const localShops = getShopsByProximity(SIMULATED_USER_LOCATION);
        const localShopIds = localShops.map(s => s.id);
        const allLocalProducts = MOCK_DATA.products.filter(p => localShopIds.includes(p.shopId));
        const categories = ['সকল পণ্য', ...new Set(allLocalProducts.map(p => p.category))];
        
        const categoryFiltersHtml = categories.map(cat => `<button class="category-btn ${cat === activeCategory || (activeCategory === 'all' && cat === 'সকল পণ্য') ? 'active' : ''}" data-cat="${cat === 'সকল পণ্য' ? 'all' : cat}">${cat}</button>` ).join('');

        page.innerHTML = `
            <div class="max-w-7xl mx-auto px-4">
                <div class="mb-6">
                    <button class="back-btn-static" onclick="renderShops()"><i class="fas fa-arrow-left"></i> হোমপেজে ফিরুন</button>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-3">আপনার এলাকার সকল পণ্য</h2>
                 <div id="all-product-category-filters" class="flex flex-wrap gap-3 mb-8 bg-white p-4 rounded-xl shadow-sm">
                    ${categoryFiltersHtml}
                 </div>
                <div id="all-products-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-6 mb-12">
                </div>
            </div>
        `;

        renderProductGrid(filter, activeCategory, '#all-products-container', Infinity);
        
        $$('#all-product-category-filters .category-btn').forEach(b => b.addEventListener('click', (e) => {
            $$('#all-product-category-filters .category-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            renderAllProductsPage($('#search-bar').value, e.target.dataset.cat);
        }));
    }

    // --- Homepage Render ---
    function renderShops(filter = '') {
      showPage('main-page');
      const page = $('#main-page');
      
      const localShops = getShopsByProximity(SIMULATED_USER_LOCATION);
      const filteredShops = localShops.filter(s => s.name.toLowerCase().includes(filter.toLowerCase()));
      
      const localShopIds = localShops.map(s => s.id);
      const allLocalProducts = MOCK_DATA.products.filter(p => localShopIds.includes(p.shopId));
      const categories = ['সকল পণ্য', ...new Set(allLocalProducts.map(p => p.category))];
      const initialCategory = 'সকল পণ্য';

      const showProductSeeMore = allLocalProducts.length > MAX_HOME_PRODUCTS;
      const shopsToDisplay = filteredShops.slice(0, MAX_HOME_SHOPS);
      const showShopSeeMore = filteredShops.length > MAX_HOME_SHOPS;
      
      const categoryFiltersHtml = categories.map(cat => `<button class="category-btn ${cat === initialCategory ? 'active' : ''}" data-cat="${cat === 'সকল পণ্য' ? 'all' : cat}">${cat}</button>` ).join('');
      
      const shopList = shopsToDisplay.length === 0 
          ? `<p class="text-center col-span-full text-gray-500">আপনার এলাকায় কোনো নিবন্ধিত দোকান খুঁজে পাওয়া যায়নি।</p>`
          : `<div id="shops-container-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              ${renderShopCardsHTML(shopsToDisplay)}
            </div>`;
            
      page.innerHTML = `
        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 text-center mb-6">জনপ্রিয় পণ্যসমূহ</h2>
        <div id="product-category-filters" class="flex flex-wrap justify-center gap-3 mb-8 bg-white p-4 rounded-xl shadow-sm">
          ${categoryFiltersHtml}
        </div>
        <div id="products-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-6 mb-8">
        </div>
        ${showProductSeeMore ? `<div class="text-center mb-12">
            <button id="see-more-products-btn" class="text-white bg-[#00BFA6] hover:bg-[#00a892] py-2 px-6 rounded-full font-semibold transition"><i class="fas fa-search-plus mr-2"></i> আরও পণ্য দেখুন</button>
        </div>` : ''}

        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 text-center mb-6 mt-12">আপনার এলাকার দোকানসমূহ</h2>
        ${shopList}
        ${showShopSeeMore ? `<div class="text-center mt-6">
            <button id="see-all-shops-btn" class="text-white bg-[#00BFA6] hover:bg-[#00a892] py-2 px-6 rounded-full font-semibold transition"><i class="fas fa-store mr-2"></i> সকল দোকান দেখুন</button>
        </div>` : ''}
      `;

      renderProductGrid(filter, 'all', '#products-container', MAX_HOME_PRODUCTS); 

      $$('#shops-container-grid [data-shop-id]').forEach(card => {
        card.addEventListener('click', () => renderShopProducts(card.dataset.shopId));
      });
      
      $$('#product-category-filters .category-btn').forEach(b => b.addEventListener('click', (e) => {
        $$('#product-category-filters .category-btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        renderProductGrid($('#search-bar').value, e.target.dataset.cat, '#products-container', MAX_HOME_PRODUCTS);
      }));

      if(showProductSeeMore) {
          $('#see-more-products-btn').addEventListener('click', () => renderAllProductsPage());
      }
      if(showShopSeeMore) {
          $('#see-all-shops-btn').addEventListener('click', renderAllShopsPage);
      }

      updateCartCount();
    }

    // --- renderShopProducts (Shop Profile) ---
    function renderShopProducts(shopId, activeCategory = 'all', isFiltering = false) {
      const shop = MOCK_DATA.shops.find(s => s.id === shopId);
      let products = MOCK_DATA.products.filter(p => p.shopId === shopId);
      const categories = ['all', ...new Set(products.map(p => p.category))];

      let filteredProducts = activeCategory === 'all' ? products : products.filter(p => p.category === activeCategory);
      
      const isFollowed = followedShops.includes(shopId);

      const page = $('#shop-products-page');
      page.innerHTML = `
        <div class="max-w-7xl mx-auto px-4">
          <div class="mb-6">
              <button class="back-btn-static" onclick="renderShops()"><i class="fas fa-arrow-left"></i> দোকান তালিকায় ফিরুন</button>
          </div>
          
          <div class="shop-cover mb-6 rounded-xl overflow-hidden"><img src="${shop.cover}" alt="${shop.name} cover" loading="lazy"></div>

          <div class="bg-white p-6 rounded-xl shadow-lg mb-8 shop-info">
            <div class="flex items-start justify-between flex-wrap">
              <div class="flex items-start gap-4 flex-grow min-w-0">
                <img src="${shop.imageUrl}" alt="${shop.name}" class="shop-profile flex-shrink-0" loading="lazy">
                <div>
                  <div>
                    <h2 class="text-2xl md:text-3xl font-bold">${shop.name}</h2>
                    <p class="text-sm text-gray-600 mt-1"><i class="fas fa-map-marker-alt text-[#00BFA6] mr-1"></i>${shop.address}</p>
                  </div>
                  <div class="stats-bar mt-3">
                    <span class="text-yellow-500"><i class="fas fa-star"></i> ${shop.rating} রেটিং</span>
                    <span><i class="fas fa-shopping-bag"></i> ${products.length} পণ্য</span>
                  </div>
                </div>
              </div>
              <button id="follow-shop-btn" class="follow-btn mt-4 md:mt-0 ${isFollowed ? 'following' : ''}" data-id="${shopId}">
                <i class="fas fa-${isFollowed ? 'check' : 'plus'} mr-1"></i> ${isFollowed ? 'অনুসরণ করছেন' : 'অনুসরণ করুন'}
              </button>
            </div>
          </div>

          <h3 class="text-2xl font-bold text-gray-800 mb-5">সব পণ্য</h3>

          <div id="shop-category-filters" class="flex flex-wrap gap-3 mb-8">
             ${categories.map(cat => `
                <button class="category-btn ${cat === activeCategory ? 'active' : ''}" data-cat="${cat}">${cat === 'all' ? 'সকল পণ্য' : cat}</button>
             `).join('')}
          </div>

          <div id="shop-products-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6">
             ${filteredProducts.map(p => {
                const shop = findShop(p.shopId);
                return productCardHTML(p, shop);
             }).join('')}
             ${filteredProducts.length === 0 ? `<p class="text-center col-span-full text-gray-500 py-8">এই ক্যাটাগরিতে এই দোকানে কোনো পণ্য নেই।</p>` : ''}
          </div>

        </div>
      `;
      showPage('shop-products-page', !isFiltering);

      $$('#shop-products-container .add-to-cart').forEach(b => b.addEventListener('click', (e) => {
         e.stopPropagation(); 
         addToCart(b.dataset.id);
      }));
      $$('#shop-products-container .favorite-btn').forEach(b => b.addEventListener('click', (e) => {
         e.stopPropagation(); 
         toggleFavorite(b.dataset.id, e.currentTarget.querySelector('i'));
      }));
      $$('#shop-products-container .product-card-clickable').forEach(el => {
          el.addEventListener('click', () => renderProductDetails(el.dataset.id));
      });
      
      $$('#shop-category-filters .category-btn').forEach(b => b.addEventListener('click', (e) => {
          $$('#shop-category-filters .category-btn').forEach(btn => btn.classList.remove('active'));
          e.target.classList.add('active');
          renderShopProducts(shopId, e.target.dataset.cat, true); 
      }));
      
      $('#follow-shop-btn').addEventListener('click', (e) => toggleFollowShop(e.currentTarget.dataset.id));
    }


    // --- Shop Follow/Unfollow Logic ---
    function toggleFollowShop(shopId) {
        const shop = findShop(shopId);
        const btn = $('#follow-shop-btn');
        if (!shop || !btn) return;

        if (followedShops.includes(shopId)) {
            followedShops = followedShops.filter(id => id !== shopId);
            btn.classList.remove('following');
            btn.innerHTML = '<i class="fas fa-plus mr-1"></i> অনুসরণ করুন';
            showToast(`${shop.name} কে অনুসরণ করা বন্ধ করা হয়েছে।`);
        } else {
            followedShops.push(shopId);
            btn.classList.add('following');
            btn.innerHTML = '<i class="fas fa-check mr-1"></i> অনুসরণ করছেন';
            showToast(`${shop.name} কে অনুসরণ করা শুরু করা হয়েছে!`);
        }
        
        const currentActiveTab = document.querySelector('.profile-tab-btn.active')?.dataset.tab;
        if (!document.getElementById('profile-page').classList.contains('hidden') && currentActiveTab === 'followed') {
            renderFollowedShops();
        }
    }


    // --- Cart Functions (Multi-shop Enabled) ---
    function addToCart(productId, quantity = 1) {
      const product = findProduct(productId);
      const cartItem = cart.find(i => i.id === productId);

      if (product) {
        if (cartItem) {
          cartItem.quantity += quantity;
        } else {
          cart.push({...product, quantity: quantity, shopName: findShop(product.shopId).name, shopId: product.shopId});
        }
        updateCartCount();
        showToast(`${product.name} কার্টে যোগ করা হয়েছে।`);
      }
    }

    function removeCartItem(productId) {
        cart = cart.filter(i => i.id !== productId);
        renderCart(false); 
        updateCartCount();
        showToast('কার্ট থেকে পণ্য সরানো হয়েছে।');
    }

    function updateCartItemQuantity(productId, action) {
        const item = cart.find(i => i.id === productId);
        if (!item) return;

        if (action === 'increment') {
            item.quantity++;
        } else if (action === 'decrement' && item.quantity > 1) {
            item.quantity--;
        } else if (action === 'decrement' && item.quantity === 1) {
            removeCartItem(productId);
            return;
        }
        renderCart(false); 
    }
    
    // --- Cart Page Render (Multi-Shop) ---
    function renderCart(shouldScroll = true) {
      const page = $('#cart-page');
      showPage('cart-page', shouldScroll);
      
      if (cart.length === 0) {
        page.innerHTML = `
          <div class="max-w-xl mx-auto text-center py-20 bg-white rounded-xl shadow">
            <i class="fas fa-shopping-cart text-6xl text-gray-300 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-700 mb-2">আপনার কার্ট খালি</h2>
            <p class="text-gray-500">কেনাকাটা শুরু করতে হোমপেজে ফিরে যান।</p>
            <button class="mt-6 bg-[#00BFA6] hover:bg-[#00a892] text-white py-2 px-6 rounded-full font-semibold transition" onclick="renderShops()">
              <i class="fas fa-arrow-left mr-2"></i> কেনাকাটা শুরু করুন
            </button>
          </div>
        `;
        return;
      }
      
      const shopsInCart = cart.reduce((acc, item) => {
        if (!acc[item.shopId]) {
          acc[item.shopId] = { shopName: item.shopName, items: [] };
        }
        acc[item.shopId].items.push(item);
        return acc;
      }, {});

      const numberOfShops = Object.keys(shopsInCart).length;
      const subtotal = cart.reduce((s,i)=> s + i.price * i.quantity, 0);
      const totalShippingCost = SHIPPING_COST * numberOfShops;
      const grandTotal = subtotal + totalShippingCost;

      const shopCartsHtml = Object.entries(shopsInCart).map(([shopId, shopData]) => {
          const shopSubtotal = shopData.items.reduce((s, i) => s + i.price * i.quantity, 0);
          return `
            <div class="bg-white rounded-xl shadow p-6 mb-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">${shopData.shopName}</h3>
                    <p class="text-sm font-semibold">মোট: ৳${shopSubtotal}</p>
                </div>
                <div>
                    ${shopData.items.map(item => `
                         <div class="flex items-center justify-between border-b last:border-b-0 py-4">
                          <div class="flex items-center gap-4 min-w-0">
                            <img src="${item.imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-lg flex-shrink-0">
                            <div class="min-w-0"><h4 class="font-semibold text-gray-800 truncate">${item.name}</h4><p class="text-sm text-gray-500">৳${item.price}</p></div>
                          </div>
                          <div class="flex items-center gap-2 sm:gap-4 flex-shrink-0">
                            <div class="flex items-center border rounded-full">
                              <button class="cart-quantity-btn w-7 h-7 sm:w-8 sm:h-8 text-lg text-gray-600 rounded-full hover:bg-gray-100" data-id="${item.id}" data-action="decrement">-</button>
                              <span class="w-8 text-center font-medium">${item.quantity}</span>
                              <button class="cart-quantity-btn w-7 h-7 sm:w-8 sm:h-8 text-lg text-gray-600 rounded-full hover:bg-gray-100" data-id="${item.id}" data-action="increment">+</button>
                            </div>
                            <button class="cart-remove-btn text-red-500 hover:text-red-700 text-lg" aria-label="Remove item" data-id="${item.id}"><i class="fas fa-trash-alt"></i></button>
                          </div>
                        </div>
                    `).join('')}
                </div>
            </div>
          `;
      }).join('');
      
      const backButtonHtml = `<div class="mb-6"><button class="back-btn-static" onclick="renderShops()"><i class="fas fa-arrow-left mr-2"></i> কেনাকাটা চালিয়ে যান</button></div>`;

      page.innerHTML = `
        <div class="max-w-6xl mx-auto">
            ${backButtonHtml}
            <h2 class="text-3xl font-bold text-gray-800 mb-6">আপনার কার্ট</h2>
            <div class="grid md:grid-cols-3 gap-8">
                <div class="md:col-span-2">
                  ${shopCartsHtml}
                </div>
                <div class="md:col-span-1 bg-white rounded-xl shadow p-6 h-fit sticky top-24">
                  <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-3">সর্বমোট সারাংশ</h3>
                  <div class="space-y-2 text-gray-700">
                    <div class="flex justify-between"><span>পণ্যের মোট মূল্য</span><span>৳${subtotal}</span></div>
                    <div class="flex justify-between"><span>ডেলিভারি চার্জ (${numberOfShops}টি দোকান)</span><span>৳${totalShippingCost}</span></div>
                    <div class="flex justify-between border-b pb-3"><span class="text-xs text-gray-500">(প্রতি দোকানে ৳${SHIPPING_COST})</span></div>
                    <div class="flex justify-between text-xl font-bold pt-3 text-[#00BFA6]"><span>সর্বমোট</span><span>৳${grandTotal}</span></div>
                  </div>
                  <button id="place-order" class="w-full bg-[#00BFA6] hover:bg-[#00a892] text-white py-3 rounded-lg font-semibold text-lg transition mt-6">
                    <i class="fas fa-truck mr-2"></i> অর্ডার নিশ্চিত করুন
                  </button>
                </div>
            </div>
        </div>
      `;
      attachCartListeners(grandTotal);
    }

    function attachCartListeners(total) {
      $('#place-order').addEventListener('click', () => placeOrder(total));
      $$('.cart-quantity-btn').forEach(b => b.addEventListener('click', () => updateCartItemQuantity(b.dataset.id, b.dataset.action)));
      $$('.cart-remove-btn').forEach(b => b.addEventListener('click', () => removeCartItem(b.dataset.id)));
    }

    // --- Order & Checkout Logic (Multi-Shop) ---
    function showCheckoutModal(numOrders, total) {
        $('#modal-title').textContent = `অর্ডার সফল`;
        $('#modal-message').textContent = `আপনার ${numOrders}টি দোকান থেকে অর্ডার সফলভাবে প্রক্রিয়াকরণ করা হয়েছে।`;
        $('#modal-order-id-container').classList.add('hidden');
        $('#modal-total').textContent = `৳${total}`;
        $('#checkout-modal').classList.remove('hidden');
        setTimeout(()=>$('#checkout-modal').classList.add('active'), 10);
    }

    function hideCheckoutModal() {
        $('#checkout-modal').classList.remove('active');
        setTimeout(() => {
            $('#checkout-modal').classList.add('hidden');
            renderShops(); 
        }, 300);
    }

    function placeOrder(grandTotal) {
      const shopsInCart = cart.reduce((acc, item) => {
        if (!acc[item.shopId]) { acc[item.shopId] = { items: [] }; }
        acc[item.shopId].items.push(item);
        return acc;
      }, {});

      const numOrders = Object.keys(shopsInCart).length;

      Object.entries(shopsInCart).forEach(([shopId, shopData]) => {
          const orderId = `ord_${Date.now()}_${shopId.slice(-2)}`;
          const productTotal = shopData.items.reduce((s, i) => s + i.price * i.quantity, 0);
          
          const newOrder = {
              id: orderId,
              date: new Date().toLocaleDateString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric' }),
              productTotal: productTotal,
              shipping: SHIPPING_COST,
              total: productTotal + SHIPPING_COST,
              status: 'প্রসেসিং চলছে',
              shopId: shopId, 
              items: shopData.items.map(i => ({ name: i.name, quantity: i.quantity, price: i.price }))
          };
          orderHistory.unshift(newOrder); 
      });

      cart = [];
      updateCartCount();
      
      showCheckoutModal(numOrders, grandTotal); 
    }

    // --- Profile Page Logic (With Back Button Logic) ---
    function renderProfile() {
        showPage('profile-page');
        const page = $('#profile-page');
        
        const tabs = [
            { id: 'orders', name: 'আমার অর্ডারসমূহ', renderer: renderOrderHistory },
            { id: 'favorites', name: 'পছন্দের পণ্য', renderer: renderFavoriteProducts },
            { id: 'followed', name: 'অনুসরণ করা দোকান', renderer: renderFollowedShops },
        ];
        
        const initialTab = 'orders';
        const backButtonHtml = `<div class="mb-6"><button class="back-btn-static" onclick="renderShops()"><i class="fas fa-arrow-left mr-2"></i> হোমপেজে ফিরুন</button></div>`;

        page.innerHTML = `
            <div class="max-w-4xl mx-auto px-4">
                ${backButtonHtml}
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8 text-center">
                    <i class="fas fa-user-circle text-6xl text-[#00BFA6] mb-3"></i>
                    <h2 class="text-2xl font-bold text-gray-800">ইউজার প্রোফাইল</h2>
                    <p class="text-gray-500">GoBazar-এ স্বাগতম</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg mb-8">
                    <div class="flex border-b">
                        ${tabs.map(t => `
                            <button class="profile-tab-btn ${t.id === initialTab ? 'active' : ''}" data-tab="${t.id}">${t.name}</button>
                        `).join('')}
                    </div>
                    <div id="profile-content" class="p-6">
                        </div>
                </div>
            </div>
        `;
        
        $$('.profile-tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tabId = e.target.dataset.tab;
                $$('.profile-tab-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                
                const selectedTab = tabs.find(t => t.id === tabId);
                if (selectedTab) {
                    selectedTab.renderer();
                }
            });
        });

        renderOrderHistory();
    }
    
    // --- Profile Tab Renderers ---
    function renderOrderHistory() {
        const container = $('#profile-content');
        if (orderHistory.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 py-8">আপনার কোনো অর্ডার ইতিহাস পাওয়া যায়নি।</p>`;
            return;
        }

        container.innerHTML = orderHistory.map(order => {
            const statusColor = order.status === 'ডেলিভারি হয়েছে' ? 'text-[#00BFA6]' : 'text-yellow-600';
            const shop = findShop(order.shopId);
            return `
                <div class="bg-gray-50 p-4 rounded-lg mb-4 border hover:border-[#00BFA6] transition cursor-pointer order-item" data-id="${order.id}">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-sm text-gray-700">অর্ডার #${order.id.split('_')[1]}</span>
                        <span class="text-xs ${statusColor} font-medium">${order.status}</span>
                    </div>
                    <p class="text-sm text-gray-600">দোকান: ${shop ? shop.name : 'অজানা দোকান'}</p>
                    <p class="text-sm text-gray-500">${order.date}</p>
                    <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-200">
                        <span class="font-bold text-lg text-gray-800">মোট: ৳${order.total}</span>
                        <span class="text-sm text-[#00BFA6] hover:underline">বিস্তারিত দেখুন</span>
                    </div>
                </div>
            `;
        }).join('');
        
        $$('.order-item').forEach(el => {
            el.addEventListener('click', () => showOrderDetailModal(el.dataset.id));
        });
    }

    function renderFavoriteProducts() {
        const container = $('#profile-content');
        if (favoriteProducts.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 py-8">আপনার পছন্দের তালিকায় কোনো পণ্য নেই।</p>`;
            return;
        }

        const favProducts = favoriteProducts.map(id => findProduct(id)).filter(p => p);
        
        container.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            ${favProducts.map(p => {
                const shop = findShop(p.shopId);
                return `
                    <div class="flex items-center gap-3 bg-white p-3 rounded-lg shadow-sm border">
                        <img src="${p.imageUrl}" alt="${p.name}" class="w-12 h-12 object-cover rounded-md flex-shrink-0 cursor-pointer" onclick="renderProductDetails('${p.id}')">
                        <div class="flex-grow min-w-0">
                            <h4 class="font-semibold text-gray-800 text-sm truncate cursor-pointer hover:text-[#00BFA6]" onclick="renderProductDetails('${p.id}')">${p.name}</h4>
                            <p class="text-xs text-gray-500">${shop.name}</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="font-bold text-[#00BFA6] text-sm">৳${p.price}</p>
                            <button class="favorite-btn text-red-500 hover:text-red-700 text-lg mt-1" data-id="${p.id}" title="পছন্দের তালিকা থেকে সরান">
                                <i class="fas fa-heart"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>`;
        
        $$('#profile-content .favorite-btn').forEach(b => b.addEventListener('click', (e) => {
             toggleFavorite(b.dataset.id, null); 
        }));
    }
    
    function renderFollowedShops() {
        const container = $('#profile-content');
        if (followedShops.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 py-8">আপনি কোনো দোকান অনুসরণ করছেন না।</p>`;
            return;
        }
        
        const shops = followedShops.map(id => findShop(id)).filter(s => s);
        
        container.innerHTML = `<div class="grid grid-cols-1 gap-4">
            ${shops.map(s => `
                <div class="flex items-center justify-between bg-white p-4 rounded-lg shadow-sm border" data-id="${s.id}">
                    <div class="flex items-center gap-4 cursor-pointer" onclick="renderShopProducts('${s.id}')">
                        <img src="${s.imageUrl}" alt="${s.name}" class="w-12 h-12 object-cover rounded-full flex-shrink-0">
                        <div>
                            <h4 class="font-semibold text-gray-800">${s.name}</h4>
                            <p class="text-sm text-gray-500">${s.address}</p>
                        </div>
                    </div>
                    <button class="follow-btn following text-sm py-1 px-3" data-id="${s.id}">
                       <i class="fas fa-check mr-1"></i> অনুসরণ করছেন
                    </button>
                </div>
            `).join('')}
        </div>`;
        
        $$('#profile-content .follow-btn').forEach(b => b.addEventListener('click', (e) => {
             toggleFollowShop(b.dataset.id);
        }));
    }

    // --- Order Detail Modal ---
    function showOrderDetailModal(orderId) {
        const order = orderHistory.find(o => o.id === orderId);
        if (!order) return;
        
        const shop = findShop(order.shopId);
        
        const itemsHtml = order.items.map(item => `
            <div class="flex justify-between text-sm py-1 border-b border-white/20">
                <span class="text-white/90">${item.name} x ${item.quantity}</span>
                <span class="text-white font-medium">৳${item.price * item.quantity}</span>
            </div>
        `).join('');

        const contentHtml = `
            <div class="text-white mb-4">
                <p class="font-semibold mb-1">অর্ডার আইডি: <span class="font-normal">${order.id.split('_')[1]}</span></p>
                <p class="font-semibold mb-1">দোকান: <span class="font-normal">${shop ? shop.name : 'অজানা দোকান'}</span></p>
                <p class="font-semibold mb-1">তারিখ: <span class="font-normal">${order.date}</span></p>
                <p class="font-semibold mb-1">স্ট্যাটাস: <span class="font-normal text-[#00BFA6]">${order.status}</span></p>
            </div>
            
            <h4 class="font-semibold text-white/90 mb-2 border-b border-white/30 pb-1">পণ্যসমূহ:</h4>
            <div class="space-y-1 mb-4 max-h-40 overflow-y-auto pr-2">
                ${itemsHtml}
            </div>

            <div class="bg-white/30 p-3 rounded-lg space-y-1">
                <div class="flex justify-between text-sm text-white/90">
                    <span>পণ্যের মোট মূল্য:</span>
                    <span class="font-medium">৳${order.productTotal}</span>
                </div>
                <div class="flex justify-between text-sm text-white/90 border-b border-white/20 pb-1">
                    <span>ডেলিভারি চার্জ:</span>
                    <span class="font-medium">৳${order.shipping}</span>
                </div>
                <div class="flex justify-between text-lg font-bold text-white pt-1">
                    <span>সর্বমোট:</span>
                    <span>৳${order.total}</span>
                </div>
            </div>
        `;

        $('#order-detail-content').innerHTML = contentHtml;
        $('#order-detail-modal').classList.remove('hidden');
        setTimeout(() => $('#order-detail-modal').classList.add('active'), 10);
    }

    function hideOrderDetailModal() {
        $('#order-detail-modal').classList.remove('active');
        setTimeout(() => $('#order-detail-modal').classList.add('hidden'), 300);
    }

    // --- Init UI bindings ---
    document.addEventListener('DOMContentLoaded', ()=> {
      renderShops();
      $('#cart-btn').addEventListener('click', renderCart);
      $('#profile-btn').addEventListener('click', renderProfile);
      $('#customer-logo').addEventListener('click', () => renderShops());
      
      $('#search-bar').addEventListener('input', (e) => {
          const filter = e.target.value;
          if (!document.getElementById('main-page').classList.contains('hidden')) {
            renderShops(filter);
          }
          if (!document.getElementById('all-products-page').classList.contains('hidden')) {
             const activeCategory = document.querySelector('#all-product-category-filters .active')?.dataset.cat || 'all';
             renderAllProductsPage(filter, activeCategory);
          }
      });
      
      $('#modal-close-btn').addEventListener('click', hideCheckoutModal);
      $('#checkout-modal').addEventListener('click', (e) => {
        if (e.target.id === 'checkout-modal') hideCheckoutModal();
      });

      $('#order-detail-close-btn').addEventListener('click', hideOrderDetailModal);
      $('#order-detail-close-btn-x').addEventListener('click', hideOrderDetailModal);
      $('#order-detail-modal').addEventListener('click', (e) => {
        if (e.target.id === 'order-detail-modal') hideOrderDetailModal();
      });

      updateCartCount();
    });
  </script>
</body>
</html>

